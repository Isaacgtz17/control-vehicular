<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Escáner Móvil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
  </head>
  <body class="bg-gray-200">
    <div class="container mx-auto max-w-lg p-4">
      <h1 class="text-2xl font-bold text-center text-slate-800 mb-4">
        Escáner de Acceso Vehicular
      </h1>

      <!-- Contenedor del Escáner QR -->
      <div id="qr-scanner-container">
        <div
          id="reader"
          class="w-full border-4 border-gray-400 rounded-lg overflow-hidden mb-4"
        ></div>
      </div>

      <!-- Contenedor de Captura de Foto (inicialmente oculto) -->
      <div id="photo-capture-container" class="hidden">
        <video
          id="camera-preview"
          class="w-full rounded-lg mb-4"
          autoplay
          playsinline
        ></video>
        <canvas id="photo-canvas" class="hidden"></canvas>
        <button
          id="capture-btn"
          class="w-full bg-green-600 text-white font-bold py-3 rounded-lg text-lg"
        >
          Tomar Foto y Registrar
        </button>
      </div>

      <!-- Panel de Resultados -->
      <div
        id="result-panel"
        class="bg-white p-4 rounded-lg shadow-md text-center"
      >
        <p id="status-text" class="text-gray-500">
          Apunte la cámara al código QR...
        </p>
      </div>

      <div class="mt-6 text-center">
        <a
          href="{{ url_for('main.index') }}"
          class="text-white bg-slate-600 hover:bg-slate-700 px-5 py-3 rounded-lg"
          >Volver al Dashboard</a
        >
      </div>
    </div>

    <script>
      const qrScannerContainer = document.getElementById(
        "qr-scanner-container"
      );
      const photoCaptureContainer = document.getElementById(
        "photo-capture-container"
      );
      const cameraPreview = document.getElementById("camera-preview");
      const photoCanvas = document.getElementById("photo-canvas");
      const captureBtn = document.getElementById("capture-btn");
      const resultPanel = document.getElementById("result-panel");
      const statusText = document.getElementById("status-text");

      let qrCodeData = null;
      let stream = null;

      function onScanSuccess(decodedText, decodedResult) {
        html5QrcodeScanner.clear();
        qrScannerContainer.classList.add("hidden");
        statusText.textContent = `QR detectado: ${decodedText.substring(
          0,
          8
        )}...`;
        qrCodeData = decodedText;
        startCameraForPhoto();
      }

      function startCameraForPhoto() {
        photoCaptureContainer.classList.remove("hidden");
        statusText.textContent = "Prepare la cámara para la foto de evidencia.";

        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((s) => {
            stream = s;
            cameraPreview.srcObject = stream;
          })
          .catch((err) => {
            console.error("Error al acceder a la cámara:", err);
            statusText.textContent = "Error al activar la cámara para la foto.";
          });
      }

      captureBtn.addEventListener("click", () => {
        if (!stream) return;

        statusText.textContent = "Procesando y subiendo...";
        captureBtn.disabled = true;
        captureBtn.classList.add("opacity-50");

        const context = photoCanvas.getContext("2d");
        photoCanvas.width = cameraPreview.videoWidth;
        photoCanvas.height = cameraPreview.videoHeight;
        context.drawImage(
          cameraPreview,
          0,
          0,
          photoCanvas.width,
          photoCanvas.height
        );

        const photoBase64 = photoCanvas.toDataURL("image/jpeg", 0.8);

        // Detener la cámara
        stream.getTracks().forEach((track) => track.stop());

        // Enviar datos al servidor
        fetch("{{ url_for('main.verificar_qr') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ qr_id: qrCodeData, photo: photoBase64 }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "autorizado") {
              resultPanel.className =
                "bg-green-100 p-4 rounded-lg shadow-md text-center";
              statusText.innerHTML = `<strong class="text-lg text-green-800">${data.message}</strong><br><span class="text-green-700">${data.placa}</span>`;
            } else {
              resultPanel.className =
                "bg-red-100 p-4 rounded-lg shadow-md text-center";
              statusText.innerHTML = `<strong class="text-lg text-red-800">ERROR</strong><br><span class="text-red-700">${data.message}</span>`;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            resultPanel.className =
              "bg-red-100 p-4 rounded-lg shadow-md text-center";
            statusText.innerHTML = `<strong class="text-lg text-red-800">ERROR DE RED</strong>`;
          })
          .finally(() => {
            photoCaptureContainer.classList.add("hidden");
          });
      });

      const html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: { width: 250, height: 250 } },
        false
      );
      html5QrcodeScanner.render(onScanSuccess, (error) => {});
    </script>
  </body>
</html>
