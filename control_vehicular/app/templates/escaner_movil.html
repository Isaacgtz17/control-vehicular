<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Escáner Móvil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para escanear QR -->
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
  </head>
  <body class="bg-gray-200">
    <div class="container mx-auto max-w-lg p-4">
      <h1 class="text-2xl font-bold text-center text-slate-800 mb-4">
        Escáner de Acceso Vehicular
      </h1>

      <!-- Visor de la cámara -->
      <div
        id="reader"
        class="w-full border-4 border-gray-400 rounded-lg overflow-hidden mb-4"
      ></div>

      <!-- Panel de Resultados -->
      <div
        id="result-panel"
        class="bg-white p-4 rounded-lg shadow-md text-center"
      >
        <p id="status-text" class="text-gray-500">
          Apunte la cámara al código QR del vehículo...
        </p>
      </div>

      <div class="mt-6 text-center">
        <a
          href="{{ url_for('main.index') }}"
          class="text-white bg-slate-600 hover:bg-slate-700 px-5 py-3 rounded-lg"
        >
          Volver al Dashboard
        </a>
      </div>
    </div>

    <script>
      const resultPanel = document.getElementById("result-panel");
      const statusText = document.getElementById("status-text");
      let lastScannedCode = null;
      let scanCooldown = false;

      function onScanSuccess(decodedText, decodedResult) {
        // Si ya estamos en cooldown, ignoramos el escaneo.

        // Para evitar múltiples envíos del mismo código
        if (decodedText === lastScannedCode) {
          return;
        }

        console.log(`Código detectado: ${decodedText}`);
        lastScannedCode = decodedText;
        scanCooldown = true; // Activamos el cooldown

        statusText.textContent = "Procesando...";
        statusText.className = "text-blue-600 font-bold";

        // Enviamos el código al servidor
        fetch("{{ url_for('main.verificar_qr') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ qr_id: decodedText }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Respuesta del servidor:", data);
            if (data.status === "autorizado") {
              resultPanel.className =
                "bg-green-100 p-4 rounded-lg shadow-md text-center";
              statusText.innerHTML = `<strong class="text-lg text-green-800">${data.message}</strong><br><span class="text-green-700">${data.placa} - ${data.modelo}</span>`;
            } else {
              resultPanel.className =
                "bg-red-100 p-4 rounded-lg shadow-md text-center";
              statusText.innerHTML = `<strong class="text-lg text-red-800">ACCESO DENEGADO</strong><br><span class="text-red-700">${data.message}</span>`;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            resultPanel.className =
              "bg-red-100 p-4 rounded-lg shadow-md text-center";
            statusText.innerHTML = `<strong class="text-lg text-red-800">ERROR</strong><br><span class="text-red-700">No se pudo conectar al servidor.</span>`;
          })
          .finally(() => {
            // Después de 5 segundos, reseteamos para poder escanear de nuevo.
            setTimeout(() => {
              scanCooldown = false;
              lastScannedCode = null;
              statusText.textContent =
                "Apunte la cámara al código QR del vehículo...";
              statusText.className = "text-gray-500";
              resultPanel.className =
                "bg-white p-4 rounded-lg shadow-md text-center";
            }, 5000);
          });
      }

      function onScanFailure(error) {
        // No hacemos nada en caso de fallo, simplemente sigue escaneando.
      }

      // Creamos la instancia del escáner
      let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: { width: 250, height: 250 } },
        /* verbose= */ false
      );

      // Iniciamos el escaneo
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    </script>
  </body>
</html>
