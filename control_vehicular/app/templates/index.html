{% extends "base_admin.html" %} {% block title %}Dashboard Principal{% endblock
%} {% block content %}
<!-- SECCIÓN DE ESTADO DE FLOTA -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div class="bg-white p-6 rounded-lg shadow-md text-center">
    <h3 class="text-lg font-semibold text-gray-500">Unidades en Patio</h3>
    <p class="text-5xl font-bold text-green-600">{{ unidades_en_patio }}</p>
  </div>
  <div class="bg-white p-6 rounded-lg shadow-md text-center">
    <h3 class="text-lg font-semibold text-gray-500">Unidades en Ruta</h3>
    <p class="text-5xl font-bold text-yellow-600">{{ unidades_en_ruta }}</p>
  </div>
  <div class="bg-white p-6 rounded-lg shadow-md text-center">
    <h3 class="text-lg font-semibold text-gray-500">Total de Unidades</h3>
    <p class="text-5xl font-bold text-slate-700">{{ total_unidades }}</p>
  </div>
</div>

<!-- ... (El resto del contenido de index.html no cambia) ... -->
<div class="bg-white p-6 rounded-lg shadow-md mb-8">
  <h2 class="text-2xl font-semibold mb-4">Registrar Nuevo Vehículo</h2>
  <form action="{{ url_for('main.registrar_vehiculo') }}" method="post">
    <div class="grid md:grid-cols-3 gap-4 mb-4">
      <input
        type="text"
        name="placa"
        placeholder="Placa del Vehículo"
        required
        class="p-2 border rounded w-full"
      />
      <input
        type="text"
        name="modelo"
        placeholder="Modelo (Ej: Ford Focus)"
        required
        class="p-2 border rounded w-full"
      />
      <input
        type="text"
        name="conductor"
        placeholder="Nombre del Conductor"
        required
        class="p-2 border rounded w-full"
      />
    </div>
    <button
      type="submit"
      class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors"
    >
      Registrar Vehículo
    </button>
  </form>
</div>
<div class="bg-white p-6 rounded-lg shadow-md mb-8">
  <div class="flex flex-col md:flex-row justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold">Bitácora de Accesos</h2>
    <form
      action="{{ url_for('main.index') }}"
      method="get"
      class="flex items-center mt-4 md:mt-0"
    >
      <input
        type="search"
        name="q_bitacora"
        value="{{ q_bitacora or '' }}"
        placeholder="Buscar en bitácora..."
        class="p-2 border rounded-l-md"
      />
      <button
        type="submit"
        class="bg-gray-600 text-white p-2 rounded-r-md hover:bg-gray-700"
      >
        Buscar
      </button>
    </form>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2 border">Fecha y Hora</th>
          <th class="p-2 border">Tipo</th>
          <th class="p-2 border">Placa</th>
          <th class="p-2 border">Modelo</th>
          <th class="p-2 border">Conductor</th>
        </tr>
      </thead>
      <tbody>
        {% for registro in registros.items %}
        <tr class="hover:bg-gray-50">
          <td class="p-2 border">{{ registro.timestamp | local_time }}</td>
          <td class="p-2 border">
            {% if registro.tipo == 'Entrada' %}<span
              class="text-green-600 font-bold"
              >{{ registro.tipo }}</span
            >{% else %}<span class="text-red-600 font-bold"
              >{{ registro.tipo }}</span
            >{% endif %}
          </td>
          <td class="p-2 border">{{ registro.vehiculo.placa }}</td>
          <td class="p-2 border">{{ registro.vehiculo.modelo }}</td>
          <td class="p-2 border">{{ registro.vehiculo.conductor }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-4">
    {% if registros.has_prev %}<a
      href="{{ url_for('main.index', page_registros=registros.prev_num, q_bitacora=q_bitacora, q_vehiculo=q_vehiculo) }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >&laquo; Anterior</a
    >{% endif %} Página {{ registros.page }} de {{ registros.pages }}. {% if
    registros.has_next %}<a
      href="{{ url_for('main.index', page_registros=registros.next_num, q_bitacora=q_bitacora, q_vehiculo=q_vehiculo) }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >Siguiente &raquo;</a
    >{% endif %}
  </div>
</div>
<div class="bg-white p-6 rounded-lg shadow-md">
  <div class="flex flex-col md:flex-row justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold">Vehículos Registrados</h2>
    <form
      action="{{ url_for('main.index') }}"
      method="get"
      class="flex items-center mt-4 md:mt-0"
    >
      <input
        type="search"
        name="q_vehiculo"
        value="{{ q_vehiculo or '' }}"
        placeholder="Buscar vehículos..."
        class="p-2 border rounded-l-md"
      />
      <button
        type="submit"
        class="bg-gray-600 text-white p-2 rounded-r-md hover:bg-gray-700"
      >
        Buscar
      </button>
    </form>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for vehiculo in vehiculos.items %}
    <div
      class="vehicle-card border p-4 rounded-lg bg-gray-50 flex flex-col text-center shadow hover:shadow-lg transition-shadow cursor-pointer"
      data-vehiculo-id="{{ vehiculo.id }}"
    >
      <div class="flex-grow w-full">
        <p class="font-bold text-lg">{{ vehiculo.placa }}</p>
        <div class="mt-1 mb-1">
          {% if vehiculo.status == 'adentro' %}<span
            class="px-3 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full"
            >ADENTRO</span
          >{% else %}<span
            class="px-3 py-1 text-xs font-semibold text-gray-800 bg-gray-200 rounded-full"
            >AFUERA</span
          >{% endif %}
        </div>
        <p>{{ vehiculo.modelo }}</p>
        <p class="text-sm text-gray-600 mb-2">{{ vehiculo.conductor }}</p>
        <img
          src="data:image/png;base64,{{ vehiculo.qr_code_b64 }}"
          alt="QR"
          class="mt-2 w-32 h-32 mx-auto"
        />
      </div>
      <div class="grid grid-cols-3 gap-2 mt-4 w-full pt-4 border-t">
        <a
          href="{{ url_for('main.descargar_qr', vehiculo_id=vehiculo.id) }}"
          class="z-10 flex items-center justify-center bg-green-500 text-white p-2 rounded-md hover:bg-green-600 text-xs"
          >Descargar</a
        >
        <a
          href="{{ url_for('main.editar_vehiculo', vehiculo_id=vehiculo.id) }}"
          class="z-10 flex items-center justify-center bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600 text-xs"
          >Editar</a
        >
        <form
          action="{{ url_for('main.eliminar_vehiculo', vehiculo_id=vehiculo.id) }}"
          method="post"
          onsubmit="return confirm('¿Seguro?');"
          class="z-10"
        >
          <button
            type="submit"
            class="w-full bg-red-500 text-white p-2 rounded-md hover:bg-red-600 text-xs"
          >
            Eliminar
          </button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="mt-4">
    {% if vehiculos.has_prev %}<a
      href="{{ url_for('main.index', page_vehiculos=vehiculos.prev_num, q_bitacora=q_bitacora, q_vehiculo=q_vehiculo) }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >&laquo; Anterior</a
    >{% endif %} Página {{ vehiculos.page }} de {{ vehiculos.pages }}. {% if
    vehiculos.has_next %}<a
      href="{{ url_for('main.index', page_vehiculos=vehiculos.next_num, q_bitacora=q_bitacora, q_vehiculo=q_vehiculo) }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >Siguiente &raquo;</a
    >{% endif %}
  </div>
</div>
<div
  id="historialModal"
  class="fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"
>
  <div
    class="relative p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white"
  >
    <div class="flex justify-between items-center pb-3 border-b">
      <h3 class="text-xl leading-6 font-medium text-gray-900" id="modalTitle">
        Historial de Acceso
      </h3>
      <button id="closeModal" class="text-black close-modal text-2xl font-bold">
        &times;
      </button>
    </div>
    <div id="modalContent" class="mt-4 max-h-96 overflow-y-auto">
      <p>Cargando...</p>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("historialModal");
    const closeModalButton = document.getElementById("closeModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");
    const vehicleCards = document.querySelectorAll(".vehicle-card");
    const openModal = () => modal.classList.remove("hidden");
    const closeModal = () => modal.classList.add("hidden");
    vehicleCards.forEach((card) => {
      card.addEventListener("click", function (event) {
        if (event.target.closest("a, button, form")) {
          return;
        }
        const vehiculoId = this.dataset.vehiculoId;
        modalContent.innerHTML = "<p>Cargando historial...</p>";
        openModal();
        fetch(`/vehiculo/historial/${vehiculoId}`)
          .then((response) => response.json())
          .then((data) => {
            modalTitle.textContent = `Historial de: ${data.placa}`;
            let contentHtml = `<p class="mb-2"><strong>Modelo:</strong> ${data.modelo}</p><p class="mb-4"><strong>Conductor:</strong> ${data.conductor}</p>`;
            if (data.historial.length > 0) {
              contentHtml += `<table class="w-full text-left border-collapse"><thead><tr class="bg-gray-200"><th class="p-2 border">Fecha y Hora</th><th class="p-2 border">Tipo</th></tr></thead><tbody>`;
              data.historial.forEach((registro) => {
                const tipoClass =
                  registro.tipo === "Entrada"
                    ? "text-green-600"
                    : "text-red-600";
                contentHtml += `<tr class="hover:bg-gray-50"><td class="p-2 border">${registro.timestamp}</td><td class="p-2 border font-bold ${tipoClass}">${registro.tipo}</td></tr>`;
              });
              contentHtml += "</tbody></table>";
            } else {
              contentHtml +=
                '<p class="text-center text-gray-500 mt-4">No hay registros de acceso para este vehículo.</p>';
            }
            modalContent.innerHTML = contentHtml;
          })
          .catch((error) => {
            console.error("Error al cargar el historial:", error);
            modalContent.innerHTML =
              '<p class="text-red-500">No se pudo cargar el historial. Por favor, intente de nuevo.</p>';
          });
      });
    });
    closeModalButton.addEventListener("click", closeModal);
    modal.addEventListener("click", function (event) {
      if (event.target === this) {
        closeModal();
      }
    });
  });
</script>
{% endblock %}
